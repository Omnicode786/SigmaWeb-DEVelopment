<section class="thread-page container my-5 text-light" data-aos="fade-up">
  <div class="col-12 col-md-12 mx-auto">

    <!-- Thread Content -->
    <div class="card bg-dark border border-secondary rounded-3 shadow-sm p-4 mb-5" data-aos="zoom-in" data-aos-duration="600">
      <h2 class="text-primary stylish-font mb-2">Title</h2>

      <h3 class="fw-bold stylish-font mb-3 text-white"><%= thread.title %></h3>
      <hr class="border-secondary opacity-25 mb-3">
      <h5 class="text-secondary mb-2">Description</h5>
      <p class="fs-5 lh-lg" style="color: rgba(255,255,255,0.85);"><%= thread.content %></p>

      <div class="d-flex justify-content-between align-items-center mt-4">
        <small class="text-muted">
          <span class="text-info">Posted by <%= thread.author ? thread.author.username : 'Unknown' %></span>
        </small>
        <small class="text-secondary"><%= thread.timeAgo %></small>
      </div>
    </div>

    <!-- Comments Section -->
    <div class="card bg-dark border border-secondary rounded-3 shadow-sm p-4 mb-5" data-aos="fade-up" data-aos-duration="700">
      <h3 class="fw-bold stylish-font mb-4"><i class="bi bi-chat-dots"></i> Comments</h3>

      <div id="comments" class="d-flex flex-column gap-4">
        <% comments.forEach(comment => { %>
          <div class="comment border-bottom border-secondary pb-3" data-id="<%= comment._id %>" data-aos="fade-up" data-aos-delay="100" data-aos-duration="600">
            <div class="comment-body">
              <strong class="text-info"><%= comment.author ? comment.author.username : 'Unknown' %></strong>
              <p class="mt-2 mb-2 text-light-80"><%= comment.content %></p>
              <div class="meta d-flex align-items-center gap-3 mt-2">
                <button class="btn btn-sm btn-outline-light rounded-pill px-3 upvote-comment stylish-font" data-id="<%= comment._id %>">
                  <i class="bi bi-hand-thumbs-up"></i>
                </button>
                <span class="upvote-count text-secondary"><%= comment.upvotes %></span>
                <button class="btn btn-sm btn-link text-decoration-none text-light show-reply-form stylish-font" data-id="<%= comment._id %>">
                  Reply
                </button>
              </div>
            </div>

            <div class="replies mt-3 ps-4 border-start border-secondary">
              <% (comment.replies || []).forEach(reply => { %>
                <div class="reply mb-3" data-id="<%= reply._id %>" data-aos="fade-right" data-aos-duration="600" data-aos-delay="150">
                  <strong class="text-warning">
                    <%= reply.author ? reply.author.username : 'Unknown' %>
                    <% if (reply.author && reply.author.role === 'admin') { %>
                      <span class="admin-badge ms-2 px-2 py-1 rounded bg-red text-light fw-bold">ADMIN</span>
                    <% } %>
                  </strong>
                  <p class="mt-1 text-light-80"><%= reply.content %></p>
                  <div class="meta d-flex align-items-center gap-3">
                    <button class="btn btn-sm btn-outline-light rounded-pill upvote-reply stylish-font" data-id="<%= reply._id %>">
                      <i class="bi bi-hand-thumbs-up"></i>
                    </button>
                    <span class="upvote-count text-secondary"><%= reply.upvotes %></span>
                  </div>
                </div>
              <% }) %>
            </div>

            <!-- Reply Form -->
            <div class="reply-form mt-3" id="reply-form-<%= comment._id %>" style="display:none;">
              <div class="toolbar mb-2">
                <button class="format-btn" data-action="bold"><i class="bi bi-type-bold"></i></button>
                <button class="format-btn" data-action="italic"><i class="bi bi-type-italic"></i></button>
                <button class="format-btn" data-action="link"><i class="bi bi-link-45deg"></i></button>
              </div>
              <textarea class="form-control bg-dark text-light border-secondary mb-2 reply-content" rows="3" placeholder="Write your reply..."></textarea>
              <button class="btn btn-outline-light btn-sm stylish-font submit-reply w-auto" data-id="<%= comment._id %>">
                <i class="bi bi-send"></i> Submit Reply
              </button>
            </div>
          </div>
        <% }) %>
      </div>
    </div>

    <!-- Add Comment -->
    <div class="card bg-dark border border-secondary rounded-3 shadow-sm p-4 mb-4" data-aos="fade-up" data-aos-duration="800">
      <h4 class="fw-bold stylish-font mb-3">Add a Comment</h4>
      <div class="toolbar mb-2">
        <button class="format-btn" data-action="bold"><i class="bi bi-type-bold"></i></button>
        <button class="format-btn" data-action="italic"><i class="bi bi-type-italic"></i></button>
        <button class="format-btn" data-action="link"><i class="bi bi-link-45deg"></i></button>
      </div>
      <textarea id="new-comment-content" rows="4" class="form-control bg-dark text-light border-secondary mb-3"
        placeholder="Share your thoughts or feedback..."></textarea>
      <button id="submit-comment" data-thread-id="<%= thread._id %>"
        class="btn btn-lg w-100 stylish-font comment-submit">
        <i class="bi bi-send"></i> Post Comment
      </button>
    </div>

  </div>
</section>

<style>
  .stylish-font {font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif; letter-spacing: 0.3px; }
  .thread-page p { line-height: 1.6; }
  .text-light-80 { color: rgba(255,255,255,0.8); }

  .btn:hover {
    background-color: white !important;
    color: black !important;
  }

  .comment, .reply, .card {
    transition: background-color 0.3s ease, transform 0.2s ease;
  }

  .comment:hover, .reply:hover {
    background-color: rgba(255,255,255,0.03);
  }

  .toolbar {
    display: flex;
    gap: 0.5rem;
  }

  .format-btn {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.7);
    border-radius: 5px;
    padding: 4px 8px;
    transition: all 0.2s;
  }

  .format-btn:hover {
    color: white;
    border-color: white;
    transform: scale(1.05);
  }

  .comment-submit {
    background: transparent;
    color: white;
    border: 2px solid white;
    transition: all 0.3s;
  }

  .comment-submit:hover {
    background-color: white;
    color: black;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  AOS.init({
    once: true,
    easing: 'ease-in-out',
    duration: 600
  });

  const submitBtn = document.getElementById("submit-comment");
  submitBtn.addEventListener("click", e => {
    e.preventDefault();
  });

  document.querySelectorAll(".format-btn").forEach(btn => {
    btn.addEventListener("click", e => {
      const textarea = btn.closest(".card, .reply-form").querySelector("textarea");
      const action = btn.dataset.action;
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      let selected = textarea.value.substring(start, end);
      let formatted = selected;

      if (action === "bold") formatted = `**${selected || "bold text"}**`;
      else if (action === "italic") formatted = `*${selected || "italic text"}*`;
      else if (action === "link") formatted = `[${selected || "link text"}](https://)`;

      textarea.setRangeText(formatted, start, end, "end");
      textarea.focus();
    });
  });

  document.querySelectorAll(".submit-reply, .upvote-comment, .upvote-reply").forEach(btn => {
    btn.addEventListener("click", e => e.preventDefault());
  });
});
</script>
